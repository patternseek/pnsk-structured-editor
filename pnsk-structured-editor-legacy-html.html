<link rel="import" href="../polymer/polymer-micro.html">

<template id="pnsk-structured-editor-legacy-html" noshadowroot>

    <style type="text/css" media="screen">
        .editor-mask {
            height: 400px;
            overflow-y: hidden;
        }

        .editor-container {
            position: relative;
            height: 400px;
        }

        .legacyhtmlbox {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .editor .ace_sb {
            display: none;
        }
    </style>
    <div class="editor-mask">
        <div class="editor-container">
            <div class="legacyhtmlbox"></div>
        </div>
    </div>
    <content></content>
</template>


<script>
    Polymer({
        is: 'pnsk-structured-editor-legacy-html',
        behaviors: [MinimalComponent],

        template: currentImport.querySelector('#pnsk-structured-editor-legacy-html'),

        dataType: "legacy-html",

      editor: null,
      html_beautify: null,

        getState: function () {
          return this.editor.getValue();
        },

        setState: function (state) {
          if (this.editor !== null) {
            this.editor.setValue(this.html_beautify(state));
            this.editor.selection.clearSelection();
          }
        },

        _onChange: function () {
            var event = new Event('pnsk-component-stateChanged');
            this.dispatchEvent(event);
        },


        // Element Lifecycle

        created: function () {

          require(["https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.4/beautify-html"], function (html_beautify) {
            this.html_beautify = html_beautify.html_beautify;
          });

          this.editor = ace.edit(this.root.querySelector(".legacyhtmlbox"));
          var session = this.editor.getSession();
          var renderer = this.editor.renderer;
          //var selection = session.getSelection();

          session.setUseWrapMode(true);
          session.setWrapLimitRange(null, null);
          //renderer.setPrintMarginColumn(80);
          session.setUseSoftTabs(true);
          session.setTabSize(4);
          this.editor.setHighlightSelectedWord(true);
          this.editor.setShowPrintMargin(false);
          this.editor.setTheme("ace/theme/twilight");
          session.setMode("ace/mode/html");
          this.editor.resize(true);
          
            this.root.querySelector(".legacyhtmlbox").addEventListener("change", this._onChange.bind(this));
            this.root.querySelector(".legacyhtmlbox").addEventListener("keyup", this._onChange.bind(this));
            this.root.querySelector(".legacyhtmlbox").addEventListener("paste", this._onChange.bind(this));
            this.root.querySelector(".legacyhtmlbox").addEventListener("cut", this._onChange.bind(this));

        }

    });

</script>
